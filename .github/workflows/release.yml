name: Auto Release MCP server

on:
  workflow_run:
    workflows: ["Rust"]
    types:
      - completed
    branches:
      - main
      - '**'  # Allow on all branches (will be filtered by release conditions)

permissions:
  contents: write
  actions: read

jobs:
  detect-version:
    name: Detect Version and Validate
    runs-on: ubuntu-latest
    # Only run if the Rust workflow succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    outputs:
      version: ${{ steps.extract.outputs.version }}
      should_release: ${{ steps.check.outputs.should_release }}
      commit_sha: ${{ github.event.workflow_run.head_sha }}
      run_id: ${{ github.event.workflow_run.id }}
    steps:
      - name: Checkout repository at workflow run commit
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0

      - name: Extract version from Cargo.toml
        id: extract
        run: |
          VERSION=$(grep '^version = ' edda/edda_mcp/Cargo.toml | head -n1 | sed 's/version = "\(.*\)"/\1/')
          echo "Extracted version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Check release conditions
        id: check
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          should_release="false"

          # Check if Cargo.toml was changed in the triggering workflow
          if git diff --name-only ${{ github.event.workflow_run.head_sha }}~1 ${{ github.event.workflow_run.head_sha }} | grep -q "edda/edda_mcp/Cargo.toml"; then
            # For main branch, always release on Cargo.toml change
            if [[ "${{ github.event.workflow_run.head_branch }}" == "main" ]]; then
              should_release="true"
              echo "Release detected: Cargo.toml change on main"
            else
              # For PRs, check for [release] keyword
              PR_NUM=$(gh pr list --head "${{ github.event.workflow_run.head_branch }}" --json number --jq '.[0].number')
              if [ -n "$PR_NUM" ]; then
                if gh pr view $PR_NUM --json commits --jq '.commits[].messageHeadline' | grep -q "\[release\]"; then
                  should_release="true"
                  echo "Release detected: Cargo.toml change + [release] keyword in PR"
                fi
              fi
            fi
          fi

          echo "should_release=$should_release" >> $GITHUB_OUTPUT

      - name: Validate version format
        if: steps.check.outputs.should_release == 'true'
        run: |
          VERSION="${{ steps.extract.outputs.version }}"

          # Check if this is a PR or push to main
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            # PR releases must have -dev prefix
            if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+-dev ]]; then
              echo "Error: PR releases must use dev version format (e.g., 0.0.3-dev.1)"
              echo "Found: $VERSION"
              exit 1
            fi
          else
            # Main branch releases must NOT have any suffix
            if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              echo "Error: Main branch releases must follow format 0.0.0 (no suffix)"
              echo "Found: $VERSION"
              exit 1
            fi
          fi

      - name: Check if tag already exists (fail explicitly)
        if: steps.check.outputs.should_release == 'true'
        run: |
          VERSION="${{ steps.extract.outputs.version }}"
          if git rev-parse "v$VERSION" >/dev/null 2>&1; then
            echo "Error: Tag v$VERSION already exists!"
            echo "Please bump the version in edda/edda_mcp/Cargo.toml before releasing."
            exit 1
          fi
          echo "Tag v$VERSION does not exist - proceeding with release"


  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: detect-version
    if: needs.detect-version.outputs.should_release == 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Download Linux artifact
        uses: actions/download-artifact@v4
        with:
          name: edda-mcp-linux-x86_64
          path: artifacts/linux
          run-id: ${{ needs.detect-version.outputs.run_id }}
          github-token: ${{ github.token }}

      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          name: edda-mcp-macos-arm64
          path: artifacts/macos
          run-id: ${{ needs.detect-version.outputs.run_id }}
          github-token: ${{ github.token }}

      - name: Prepare artifacts for release
        run: |
          mkdir -p release
          mv artifacts/linux/edda_mcp release/edda_mcp-linux-x86_64
          mv artifacts/macos/edda_mcp release/edda_mcp-macos-arm64
          chmod +x release/*
          ls -lh release/

      - name: Create git tag
        run: |
          VERSION="${{ needs.detect-version.outputs.version }}"
          COMMIT_SHA="${{ needs.detect-version.outputs.commit_sha }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git tag "v$VERSION" "$COMMIT_SHA"
          git push origin "v$VERSION"

      - name: Create GitHub release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ needs.detect-version.outputs.version }}"
          COMMIT_SHA="${{ needs.detect-version.outputs.commit_sha }}"
          CI_URL="https://github.com/${{ github.repository }}/actions/runs/${{ needs.detect-version.outputs.run_id }}"

          # Generate checksums
          cd release
          LINUX_CHECKSUM=$(sha256sum edda_mcp-linux-x86_64 | awk '{print $1}')
          MACOS_CHECKSUM=$(sha256sum edda_mcp-macos-arm64 | awk '{print $1}')
          cd ..

          cat > release_notes.md <<EOF
          Release v$VERSION

          ## SHA256 Checksums
          \`\`\`
          $LINUX_CHECKSUM  edda_mcp-linux-x86_64
          $MACOS_CHECKSUM  edda_mcp-macos-arm64
          \`\`\`

          ---
          - Built from commit: \`$COMMIT_SHA\`
          - CI Run: $CI_URL
          EOF

          gh release create "v$VERSION" \
            --repo "${{ github.repository }}" \
            --title "v$VERSION" \
            --notes-file release_notes.md \
            --latest \
            release/*

      - name: Output release URL
        run: |
          VERSION="${{ needs.detect-version.outputs.version }}"
          echo "Release created successfully!"
          echo "View at: https://github.com/${{ github.repository }}/releases/tag/v$VERSION"
